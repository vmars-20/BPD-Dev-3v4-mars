---
created: 2025-11-07
type: handoff
priority: P1
status: partially-complete
depends_on:
  - handoff-8-cocotb-test-execution
  - cascading-pyproject-strategy
migration_status: unified-on-hierarchical-encoder
---

# Handoff 8.5: BPD Integration Testing with Hierarchical Encoder

**Date:** 2025-11-07
**Session:** FORGE Integration Testing (Tier 2)
**Owner:** @claude
**Dependencies:** Handoff 8 complete (component tests pass), Two-tier strategy implemented
**Estimated Time:** 1-2 hours
**STATUS UPDATE:** Migration to unified hierarchical encoder complete (2025-11-07)

---

## Migration Status (2025-11-07)

### ‚úÖ COMPLETED: Unified FSM Observation on forge_hierarchical_encoder

The monorepo has been successfully unified to use `forge_hierarchical_encoder` as THE standard for FSM observation. Major accomplishments:

1. **fsm_observer refactored** - Now a thin wrapper around forge_hierarchical_encoder
2. **Unified decoder created** - `tools/decoder/hierarchical_decoder.py` is the single source of truth
3. **BPD integration confirmed** - BPD_forge_shim already uses hierarchical encoder directly
4. **Test constants updated** - P1/P2/P3 tests updated for new voltage expectations
5. **Documentation updated** - All CLAUDE.md files reflect the new standard

**Key Change:** Output scaling is now 200 digital units/state (~30mV steps on ¬±5V platform) instead of voltage spreading (0-2.5V).

---

## Executive Summary

Run **Tier 2 integration tests** for BPD FSM Observer with the new hierarchical encoder decoder. This validates that the encoder (tested in Handoff 8) correctly integrates with BPD's FSM observer pattern.

**Scope:**
1. Design BPD integration test strategy
2. Update BPD decoder function for hierarchical encoding
3. Run BPD FSM observer tests (integration level)
4. Validate state extraction, status extraction, and fault detection
5. Document integration test results

**Success Criteria:**
- BPD FSM observer tests pass with hierarchical decoder
- State extraction works correctly
- Status extraction works correctly
- Fault flag detection works correctly
- Integration between forge_hierarchical_encoder and BPD validated

---

## Background: Two-Tier Testing

### Tier 1: Component Testing (Handoff 8 - Complete ‚úÖ)

**What was tested:**
- `forge_hierarchical_encoder.vhd` in isolation
- Pure VHDL logic, no cross-workspace dependencies
- CocoTB tests from `libs/forge-vhdl/cocotb_test/`

**Results:**
- All 4 P1 tests passed ‚úì
- State encoding validated (0‚Üí0, 1‚Üí200, 2‚Üí400, 3‚Üí600)
- Status offset validated
- Fault sign flip validated

**Reference:** `Obsidian/Project/Test-Reports/2025-11-07-handoff-8-test-results.md`

---

### Tier 2: Integration Testing (This Handoff)

**What to test:**
- BPD FSM Observer with hierarchical encoder
- Cross-workspace integration (BPD + moku-models + forge-vhdl)
- CocoTB tests from `examples/basic-probe-driver/vhdl/cocotb_test/`

**Key Integration Points:**
1. **BPD VHDL** ‚Üí `forge_hierarchical_encoder` instantiation
2. **BPD Shim** ‚Üí Wire state_vector + status_vector to encoder
3. **CustomWrapper** ‚Üí Export OutputD to oscilloscope
4. **Python Decoder** ‚Üí Decode hierarchical voltage back to state + status

---

## Task 1: Design Integration Test Strategy

### Current BPD FSM Observer Architecture

**BPD FSM States:**
```vhdl
constant STATE_IDLE     : std_logic_vector(5 downto 0) := "000000";  -- 0
constant STATE_ARMED    : std_logic_vector(5 downto 0) := "000001";  -- 1
constant STATE_FIRING   : std_logic_vector(5 downto 0) := "000010";  -- 2
constant STATE_COOLDOWN : std_logic_vector(5 downto 0) := "000011";  -- 3
constant STATE_FAULT    : std_logic_vector(5 downto 0) := "111111";  -- 63
```

**BPD Status Pattern** (8-bit):
```vhdl
status_vector <= fault_flag & state_copy(5 downto 0) & '0';
-- status[7]   = fault flag (1 = fault)
-- status[6:1] = state copy for redundancy
-- status[0]   = 0 (reserved)
```

**Expected Digital Outputs** (from hierarchical encoder):
```
STATE_IDLE (0)     + status=0x00 ‚Üí 0 digital units (0 mV on scope)
STATE_ARMED (1)    + status=0x00 ‚Üí 200 digital units (~30 mV on scope)
STATE_FIRING (2)   + status=0x00 ‚Üí 400 digital units (~61 mV on scope)
STATE_COOLDOWN (3) + status=0x00 ‚Üí 600 digital units (~91 mV on scope)
STATE_FAULT (63)   + status=0x80 ‚Üí negative voltage (fault indicator)
```

---

### Integration Test Coverage

**Test 1: State Progression**
- Verify BPD state transitions reflected in OutputD
- Test: IDLE ‚Üí ARMED ‚Üí FIRING ‚Üí COOLDOWN ‚Üí IDLE
- Expected: Voltage steps match hierarchical encoding

**Test 2: State Extraction (Decoder)**
- Read OutputD digital value from CocoTB
- Decode back to state using `decode_hierarchical_voltage()`
- Verify extracted state matches BPD internal state

**Test 3: Status Extraction (Decoder)**
- Read OutputD digital value
- Decode back to status byte
- Verify status[7] = fault flag
- Verify status[6:1] = state copy (redundancy check)

**Test 4: Fault Detection**
- Trigger fault condition in BPD
- Verify OutputD goes negative (sign flip)
- Verify decoder extracts fault flag correctly
- Verify magnitude preserves pre-fault state

**Test 5: Magnitude Preservation During Fault**
- Record normal state voltage (e.g., STATE_FIRING = +400)
- Trigger fault
- Verify fault voltage = -400 (same magnitude, negative sign)
- Decode and verify state still shows FIRING (not FAULT state value)

---

## Task 2: Update BPD Decoder Function

### Current Decoder (Handoff 6 - Outdated)

**File:** `examples/basic-probe-driver/vhdl/cocotb_test/test_bpd_fsm_observer.py`

**Old decoder (if exists):**
```python
def decode_fsm_state(voltage_mv):
    """Old simple decoding - needs update"""
    # Maps voltage to state (outdated formula)
    pass
```

**Problem:** Doesn't account for:
- Status offset encoding
- Fault flag in status[7]
- Signed arithmetic for fault detection

---

### New Hierarchical Decoder (To Implement)

**Function Signature:**
```python
def decode_hierarchical_voltage(digital_value: int) -> dict:
    """
    Decode hierarchical voltage encoding back to state + status.

    Args:
        digital_value: Signed 16-bit digital value from OutputD

    Returns:
        dict with keys:
            'state': int (0-63, FSM state value)
            'status': int (0-255, status byte)
            'fault': bool (True if status[7] set)
            'state_copy': int (status[6:1], redundancy check)
            'voltage_mv': float (for debugging, assumes ¬±5V scale)
    """
    # Detect fault flag (negative voltage)
    fault = digital_value < 0
    magnitude = abs(digital_value)

    # Extract base state (200 digital units per state)
    base_state = magnitude // 200

    # Extract status offset
    offset = magnitude % 200  # Residual after state extraction
    status_lower = (offset * 128) // 100  # Reverse the (status * 100) / 128

    # Reconstruct status byte
    if fault:
        status = 0x80 | status_lower  # Set fault bit
    else:
        status = status_lower

    # Extract state copy from status[6:1] for validation
    state_copy = (status >> 1) & 0x3F  # Mask bits 6:1

    # Convert to mV (assuming ¬±5V = ¬±32768 digital)
    voltage_mv = (digital_value / 32768.0) * 5000.0

    return {
        'state': base_state,
        'status': status,
        'fault': fault,
        'state_copy': state_copy,
        'voltage_mv': voltage_mv
    }
```

**Validation:**
```python
# Test decoder with known values
assert decode_hierarchical_voltage(0)['state'] == 0      # IDLE
assert decode_hierarchical_voltage(200)['state'] == 1    # ARMED
assert decode_hierarchical_voltage(400)['state'] == 2    # FIRING
assert decode_hierarchical_voltage(-400)['fault'] == True  # FAULT
```

---

## Task 3: Run BPD FSM Observer Tests

### Execution Command

```bash
# Navigate to monorepo root (Tier 2 integration testing)
cd /Users/vmars20/workspace/BPD-Dev

# Run BPD FSM observer tests
uv run python examples/basic-probe-driver/vhdl/cocotb_test/run.py test_bpd_fsm_observer

# Or with Makefile (if configured)
cd examples/basic-probe-driver/vhdl
make LEVEL=P1
```

**Expected Output:**
```
Running CocoTB tests for BPD FSM Observer...

test_bpd_fsm_observer.test_bpd_fsm_observer_progressive
  ‚úì State extraction (IDLE)                              PASS
  ‚úì State extraction (ARMED)                             PASS
  ‚úì State extraction (FIRING)                            PASS
  ‚úì State extraction (COOLDOWN)                          PASS
  ‚úì Fault flag detection                                 PASS
  ‚úì Magnitude preservation during fault                  PASS

6/6 tests passed (0 failed)
Runtime: 5.2s

PASS: BPD FSM Observer integration tests
```

---

### Success Criteria

**P1 Integration Tests:**
- [ ] All tests pass (green)
- [ ] State extraction works for all BPD states
- [ ] Status extraction works (status byte decoded correctly)
- [ ] Fault flag detected when BPD enters fault state
- [ ] Magnitude preserved during fault (voltage sign flips, magnitude same)
- [ ] Output <30 lines (integration tests allowed slightly more than component P1)
- [ ] Runtime <10 seconds

---

## Task 4: Debug Integration Issues (If Any)

### Common Integration Issues

**Issue 1: BPD Doesn't Instantiate Encoder**

**Symptom:**
```
OutputD always 0, no state information
```

**Fix:**
- Check BPD shim instantiates `forge_hierarchical_encoder`
- Verify `state_vector` and `status_vector` wired correctly
- Check `voltage_out` connected to OutputD

**Files to check:**
- `examples/basic-probe-driver/vhdl/BPD_forge_shim.vhd`
- `examples/basic-probe-driver/vhdl/CustomWrapper_bpd_forge.vhd`

---

**Issue 2: Decoder Formula Mismatch**

**Symptom:**
```
Expected state=2, decoded state=1 (off by one)
```

**Fix:**
- Verify decoder uses **integer division** (`//` not `/`)
- Match Python formula to VHDL arithmetic exactly
- Test decoder with known values from Handoff 8

**Debugging:**
```python
# Test decoder against Handoff 8 expected values
test_values = [
    (0, 0x00, 0),      # STATE_IDLE, no status
    (200, 0x00, 1),    # STATE_ARMED, no status
    (400, 0x00, 2),    # STATE_FIRING, no status
    (478, 0x7F, 2),    # STATE_FIRING, max status offset
    (-400, 0x80, 2),   # STATE_FIRING, fault flag
]

for digital, expected_status, expected_state in test_values:
    decoded = decode_hierarchical_voltage(digital)
    assert decoded['state'] == expected_state
    assert decoded['status'] == expected_status
```

---

**Issue 3: BPD Status Vector Not Populated**

**Symptom:**
```
Status always 0x00, no fault detection
```

**Fix:**
- Check BPD main entity exports status_vector
- Verify BPD shim wires status_vector to encoder
- Check fault_flag logic in BPD FSM

**VHDL pattern:**
```vhdl
-- In BPD main
signal fault_flag : std_logic;
signal status_vector : std_logic_vector(7 downto 0);

status_vector <= fault_flag & state(5 downto 0) & '0';

-- In BPD shim
encoder_inst : entity work.forge_hierarchical_encoder
    port map (
        clk => Clk,
        reset => Reset,
        state_vector => state_from_main,  -- 6-bit state
        status_vector => status_from_main, -- 8-bit status
        voltage_out => OutputD             -- 16-bit signed
    );
```

---

**Issue 4: Timing - BPD State Changes Not Visible**

**Symptom:**
```
OutputD stuck at one value, doesn't update with state changes
```

**Fix:**
- Add 2 clock cycles after forcing state change (GHDL bug, see Handoff 8)
- Verify BPD FSM actually transitions (check internal state)
- Check encoder clock domain matches BPD clock

**Test pattern:**
```python
async def test_state_transition(dut):
    # Force BPD to ARMED state
    dut.force_state_armed()  # Implementation-dependent
    await ClockCycles(dut.clk, 2)  # GHDL needs 2 cycles!

    digital_value = int(dut.OutputD.value.signed_integer)
    decoded = decode_hierarchical_voltage(digital_value)

    assert decoded['state'] == 1  # ARMED
```

---

## Task 5: Document Integration Test Results

### Test Report Template

**File:** `Obsidian/Project/Test-Reports/2025-11-07-handoff-8.5-integration-test-results.md`

```markdown
# Handoff 8.5 Integration Test Results: BPD FSM Observer

**Date:** 2025-11-07
**Tester:** @claude
**Component:** BPD FSM Observer + forge_hierarchical_encoder
**Test Tier:** 2 (Integration)

---

## Executive Summary

‚úÖ / ‚ùå **ALL INTEGRATION TESTS PASSED/FAILED**

**Status:** [PASS/FAIL] - [Brief summary]

---

## Integration Test Results

**Command:** `uv run python examples/basic-probe-driver/vhdl/cocotb_test/run.py test_bpd_fsm_observer`

**Output:**
```
[Paste test output here]
```

**Metrics:**
- Total tests: X
- Passed: X
- Failed: X
- Output lines: X (<30 ‚úì/‚úó)
- Runtime: X seconds (<10 ‚úì/‚úó)

---

## Test Coverage

### State Extraction
- IDLE (state=0): ‚úì / ‚úó
- ARMED (state=1): ‚úì / ‚úó
- FIRING (state=2): ‚úì / ‚úó
- COOLDOWN (state=3): ‚úì / ‚úó

### Status Extraction
- Status byte decoding: ‚úì / ‚úó
- Fault flag extraction: ‚úì / ‚úó
- State copy validation: ‚úì / ‚úó

### Fault Detection
- Negative voltage on fault: ‚úì / ‚úó
- Magnitude preservation: ‚úì / ‚úó
- Decoder fault flag: ‚úì / ‚úó

---

## Decoder Validation

**Decoder Function:** `decode_hierarchical_voltage()`

**Test Cases:**
| Digital Value | Expected State | Expected Fault | Result |
|---------------|----------------|----------------|--------|
| 0             | 0 (IDLE)       | False          | ‚úì / ‚úó  |
| 200           | 1 (ARMED)      | False          | ‚úì / ‚úó  |
| 400           | 2 (FIRING)     | False          | ‚úì / ‚úó  |
| -400          | 2 (FIRING)     | True           | ‚úì / ‚úó  |

---

## Issues and Resolutions

### Issue 1: [Description]
**Symptom:** [What went wrong]
**Root cause:** [Why it happened]
**Fix:** [How it was resolved]
**Commit:** [Git commit hash]

---

## Next Steps

- [ ] Mark Handoff 8.5 complete (if tests pass)
- [ ] Proceed to hardware validation (Handoff 9) with Moku oscilloscope
- [ ] Or: Debug and iterate on integration (if tests fail)

---

**Test Report Generated:** 2025-11-07
**Tier:** 2 (Integration Testing)
**Reference:** Handoff 8 (component testing complete)
```

---

## Task 6: Commit Integration Tests

### Git Workflow

```bash
# Stage BPD integration test files
git add examples/basic-probe-driver/vhdl/cocotb_test/test_bpd_fsm_observer.py
git add Obsidian/Project/Test-Reports/2025-11-07-handoff-8.5-integration-test-results.md

# Commit with descriptive message
git commit -m "test: Add BPD FSM observer integration tests with hierarchical encoder (Handoff 8.5)

Implement Tier 2 integration tests for BPD FSM Observer using the
hierarchical encoder validated in Handoff 8.

## Tests Added
- State extraction for all BPD states (IDLE, ARMED, FIRING, COOLDOWN)
- Status byte decoding and validation
- Fault flag detection (negative voltage)
- Magnitude preservation during fault

## Decoder Function
- decode_hierarchical_voltage(): Digital ‚Üí state + status + fault flag
- Validates against Handoff 8 component test results
- Matches VHDL arithmetic exactly (integer division)

## Test Results
- X/X tests passed
- Output: <30 lines ‚úì
- Runtime: <10s ‚úì

## Integration Validated
- BPD main ‚Üí forge_hierarchical_encoder instantiation ‚úì
- State vector + status vector wiring ‚úì
- OutputD export to oscilloscope channel ‚úì
- Python decoder accuracy ‚úì

Reference: Handoff 8 (component tests), Handoff 8.5 (integration tests)

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# Push to remote
git push origin BPD-Dev-main
```

---

## Success Criteria

### Integration Tests
- [ ] All tests pass (green output)
- [ ] State extraction works for all BPD states
- [ ] Status extraction works correctly
- [ ] Fault flag detection works
- [ ] Magnitude preserved during fault

### Decoder Function
- [ ] `decode_hierarchical_voltage()` implemented
- [ ] Tested against Handoff 8 expected values
- [ ] Matches VHDL arithmetic (integer division)
- [ ] Handles negative voltages (fault)

### BPD Integration
- [ ] BPD instantiates `forge_hierarchical_encoder`
- [ ] State vector wired correctly
- [ ] Status vector wired correctly (includes fault flag)
- [ ] OutputD exports to oscilloscope channel

### Documentation
- [ ] Integration test report created
- [ ] Issues logged and resolved
- [ ] Commit message descriptive
- [ ] Handoff 8.5 marked complete

---

## Reference Documentation

### Related Handoffs
- **Handoff 6:** Hierarchical voltage encoding design
- **Handoff 7:** CocoTB test design for forge_hierarchical_encoder
- **Handoff 8:** Component testing (Tier 1) - forge_hierarchical_encoder P1 tests
- **Handoff 8.5:** Integration testing (Tier 2) - This handoff
- **Handoff 9:** Hardware validation (future) - Moku oscilloscope testing

### Architecture Documents
- **Cascading pyproject.toml Strategy:** `Obsidian/Project/Review/CASCADING_PYPROJECT_STRATEGY.md`
- **Two-Tier Testing:** `libs/forge-vhdl/CLAUDE.md` "Testing Workflow" section
- **BPD FORGE Architecture:** `examples/basic-probe-driver/vhdl/FORGE_ARCHITECTURE.md`

### Test Infrastructure
- **forge-vhdl Testing Standards:** `libs/forge-vhdl/CLAUDE.md`
- **CocoTB Troubleshooting:** `libs/forge-vhdl/docs/COCOTB_TROUBLESHOOTING.md`
- **Progressive Testing Guide:** `libs/forge-vhdl/docs/PROGRESSIVE_TESTING_GUIDE.md`

---

## Agent Execution

**Recommended Agent:** Use general-purpose agent or manual execution

**Delegation Pattern (if using agent):**
```
I need to execute Handoff 8.5 for BPD integration testing.

Context:
- Handoff 8 component tests passed (forge_hierarchical_encoder validated)
- Two-tier testing strategy implemented
- Need to run Tier 2 integration tests for BPD FSM Observer

Tasks:
1. Update BPD decoder function (decode_hierarchical_voltage)
2. Run BPD FSM observer tests from examples/basic-probe-driver/
3. Debug any integration issues
4. Document test results
5. Commit integration tests

Reference: Obsidian/Project/Handoffs/2025-11-07-handoff-8.5-integration-testing.md
```

---

**Created:** 2025-11-07
**Status:** Pending
**Priority:** P1 (Integration Testing)
**Dependencies:** Handoff 8 complete, two-tier strategy implemented
**Estimated Completion:** 1-2 hours active work

---

**END OF HANDOFF 8.5**
